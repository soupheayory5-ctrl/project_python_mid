<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Checkout</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="{{ url_for('static', filename='styles/styles.css') }}" />
  <script src="https://cdn.jsdelivr.net/npm/vue@3/dist/vue.global.prod.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

  <style>
    /* =========================
       Global: patterned canvas
       ========================= */
    body{
      font-family:'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      color:#0f172a; margin:0;
      /* dots + micro-dots + soft gradient */
      background:
        radial-gradient(circle at 18px 18px, rgba(15,23,42,.08) 2px, transparent 3px) 0 0/36px 36px,
        radial-gradient(circle at 9px 9px, rgba(15,23,42,.05) 1px, transparent 2px) 0 0/18px 18px,
        linear-gradient(180deg,#ffffff 0%, #f6fbff 55%, #eef6ff 100%);
    }

    /* =========================
       Container: new layout
       ========================= */
    .checkout-container{
      max-width: 1120px;
      margin: 64px auto;
      border-radius: 22px;
      overflow:hidden;
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap:0;
      box-shadow: 0 18px 45px rgba(15,23,42,.10);
      background:#fff;
      border:1px solid rgba(15,23,42,.08);
      position:relative;
    }

    /* Decorative ribbon top */
    .checkout-container::before{
      content:"";
      position:absolute; inset:0 0 auto 0; height:8px;
      background:linear-gradient(90deg,#22c55e,#3b82f6,#a78bfa,#f472b6,#f59e0b);
    }

    /* =========================
       Left / Right panels
       ========================= */
    .checkout-left, .checkout-right{ padding: 44px 48px; }

    .checkout-left{
      /* diagonal stripe background */
      background:
        repeating-linear-gradient(-45deg, rgba(37,99,235,.06) 0 26px, transparent 26px 52px),
        #ffffff;
      border-right: 6px solid transparent;
      background-clip: padding-box;
    }

    .checkout-right{
      /* checker + gradient */
      background:
        repeating-linear-gradient(45deg, #e0f2fe 0 20px, #f0f9ff 20px 40px),
        linear-gradient(#eff6ff,#dbeafe);
    }

    /* Make summary column sticky on tall pages */
    @media (min-width: 992px){
      .checkout-right{ position: sticky; top: 88px; align-self: start; }
    }

    /* =========================
       Headings
       ========================= */
    h2{
      font-weight:900; margin-bottom:22px;
      letter-spacing:.3px;
      background:linear-gradient(90deg,#2563eb,#ec4899);
      -webkit-background-clip:text; background-clip:text; color:transparent;
    }
    h4{
      margin:26px 0 14px; font-weight:800; color:#1f2937;
      display:inline-flex; align-items:center; gap:.5rem;
      padding:.25rem .8rem; border-radius:999px;
      background:linear-gradient(90deg, rgba(99,102,241,.15), rgba(236,72,153,.15));
      border:1px solid rgba(15,23,42,.08);
    }

    /* =========================
       Inputs
       ========================= */
    label{ font-weight:600; color:#334155; }
    input, textarea{
      width:100%;
      border-radius:14px;
      border:2px solid #e2e8f0;
      padding:12px 14px; margin-bottom:16px;
      background-color:#f9fafb;
      transition:border-color .18s ease, box-shadow .18s ease, transform .06s ease;
    }
    input:focus, textarea:focus{
      border-color:#2563eb; outline:none;
      box-shadow: 0 0 0 4px rgba(37,99,235,.15);
      transform: translateY(-1px);
    }

    /* =========================
       Radio groups (patterned)
       ========================= */
    .radio-group{ display:flex; flex-wrap:wrap; gap:12px; margin-bottom:18px; }
    .radio-label{
      flex:1; text-align:center; cursor:pointer; user-select:none;
      border-radius:14px; padding:12px 10px; font-weight:800;
      border:2px solid #cbd5e1; color:#0f172a;
      background:
        linear-gradient(#fff,#fff) padding-box,
        linear-gradient(90deg,#60a5fa,#a78bfa) border-box;
      transition: transform .15s ease, filter .15s ease, box-shadow .15s ease;
    }
    .radio-label i{ margin-right:8px; }
    input[type="radio"]{ display:none; }
    input[type="radio"]:checked + .radio-label{
      color:#0f172a;
      background:
        repeating-linear-gradient(135deg, #bbf7d0 0 12px, #a7f3d0 12px 24px),
        linear-gradient(90deg,#34d399,#86efac);
      border-color: transparent;
      box-shadow: 0 6px 16px rgba(52,211,153,.35);
      transform: translateY(-2px);
    }

    /* =========================
       Order summary panel
       ========================= */
    .order-summary{
      border-radius:16px; padding:24px;
      background:
        repeating-linear-gradient(135deg, rgba(255,255,255,.7) 0 24px, rgba(240,249,255,.85) 24px 48px),
        #f0f9ff;
      box-shadow: inset 0 0 14px rgba(59,130,246,.18);
      height:100%; display:flex; flex-direction:column; justify-content:space-between;
      border:1px solid rgba(15,23,42,.06);
    }
    .order-summary h4{ margin-bottom:12px; }

    .order-list{
      flex-grow:1; overflow-y:auto; margin-bottom:18px; padding-right:6px;
    }
    .order-list li{
      list-style:none; padding:10px 0;
      border-bottom:1px dashed #cbd5e1;
      display:flex; justify-content:space-between; align-items:center;
      color:#0f172a;
    }
    .order-list li:last-child{ border-bottom:none; }

    .total-amount{
      font-size:1.7rem; font-weight:900; color:#16a34a;
      padding:.25rem .75rem; border-radius:10px; display:inline-block;
      background:
        linear-gradient(#fff,#fff) padding-box,
        linear-gradient(90deg,#22c55e,#a3e635) border-box;
      border:2px solid transparent;
    }

    /* =========================
       Primary action
       ========================= */
    .btn-checkout{
      margin-top:10px; width:100%; padding:16px;
      font-weight:900; font-size:1.1rem; color:#0f172a;
      border:none; border-radius:14px; cursor:pointer;
      background:
        repeating-linear-gradient(45deg, #a78bfa 0 18px, #6366f1 18px 36px),
        linear-gradient(90deg,#818cf8,#f472b6);
      transition: transform .18s ease, filter .18s ease, box-shadow .18s ease, opacity .18s ease;
    }
    .btn-checkout:hover{
      transform: translateY(-2px);
      filter: brightness(1.05);
      box-shadow: 0 10px 24px rgba(99,102,241,.45);
    }
    .btn-checkout:disabled{
      opacity:.6; cursor:not-allowed; transform:none; box-shadow:none;
    }

    /* =========================
       Responsive tweaks
       ========================= */
    @media (max-width: 992px){
      .checkout-container{ grid-template-columns: 1fr; }
      .checkout-right{ position:static; }
      .checkout-left{ border-right:none; border-bottom:6px solid #f1f5f9; }
    }
  </style>
</head>
<body>
  {% include 'Layout/navbar.html' %}

  <div id="app">
    <div class="checkout-container">
      <div class="checkout-left">
        <h2>üõí Checkout</h2>
        <form @submit.prevent="placeOrder">
          <h4>Contact Information</h4>
          <input v-model="form.firstname" type="text" placeholder="First Name" required />
          <input v-model="form.lastname" type="text" placeholder="Last Name" required />
          <input v-model="form.number" type="tel" placeholder="Phone Number" required />
          <input v-model="form.email" type="email" placeholder="Email Address" required />

          <h4>Delivery Method</h4>
          <div class="radio-group">
            <input v-model="form.delivery" type="radio" value="store" id="delivery-store" @change="updatePaymentOptions" hidden />
            <label :for="'delivery-store'" :class="['radio-label', form.delivery === 'store' ? 'active' : '']">
              <i class="fa-solid fa-store"></i> Store Pickup
            </label>

            <input v-model="form.delivery" type="radio" value="delivery" id="delivery-delivery" hidden @change="updatePaymentOptions" />
            <label :for="'delivery-delivery'" :class="['radio-label', form.delivery === 'delivery' ? 'active' : '']">
              <i class="fa-solid fa-truck"></i> Home Delivery
            </label>
          </div>

          <textarea v-model="form.address" rows="3" placeholder="Shipping Address or Map Link" required @input="updatePaymentOptions"></textarea>

          <h4>Payment Method</h4>
  <div class="radio-group">
    <input v-model="form.payment" type="radio" value="cash" id="payment-cash" :disabled="!allowCash" hidden />
    <label :for="'payment-cash'" :class="['radio-label', form.payment === 'cash' ? 'active' : '']">Cash</label>

    <input v-model="form.payment" type="radio" value="KHQR" id="payment-khqr" :disabled="!allowKHQR" hidden />
    <label :for="'payment-khqr'" :class="['radio-label', form.payment === 'KHQR' ? 'active' : '']">KHQR</label>

    <input v-model="form.payment" type="radio" value="Cards" id="payment-cards" :disabled="!allowCards" hidden />
    <label :for="'payment-cards'" :class="['radio-label', form.payment === 'Cards' ? 'active' : '']">Cards</label>
  </div>

          <button type="submit" class="btn-checkout" :disabled="!validCheckout">Place Order</button>
        </form>
      </div>

      <div class="checkout-right">
        <div class="order-summary">
          <h4>üõç Order Summary</h4>
          {% raw %}
<ul class="order-list">
  <li v-for="item in displayCart" :key="item.id">
    <span>{{ item.title }} (x{{ item.quantity }})</span>
    <strong>${{ (item.price * item.quantity).toFixed(2) }}</strong>
  </li>
</ul>
<div class="total-amount">${{ totalAmount.toFixed(2) }}</div>
{% endraw %}

          {% raw %}
              <div class="total-amount">${{ totalAmount.toFixed(2) }}</div>
          {% endraw %}
        </div>
      </div>
    </div>
  </div>

  {% include 'Layout/footer.html' %}

  <script>
  // Helper to read/write the compact cart (id + quantity)
  function readCart() {
    const raw = JSON.parse(localStorage.getItem('cart_list') || '[]');
    // tolerate legacy carts that had price/title fields
    return raw.map(x => ({ id: Number(x.id), quantity: Number(x.quantity || 1) }))
              .filter(x => Number.isFinite(x.id) && x.id > 0 && x.quantity > 0);
  }
  function writeCart(cart) {
    localStorage.setItem('cart_list', JSON.stringify(cart));
  }

  const app = Vue.createApp({
    data() {
      return {
        cart: [],              // [{id, quantity}]
        productsById: {},      // { id: productFromDB }
        form: {
          firstname: '',
          lastname: '',
          email: '',
          number: '',
          delivery: 'store',
          address: '',
          payment: 'cash',
        },
      };
    },

    computed: {
      // Merge DB data with quantities for rendering
      displayCart() {
        return this.cart
          .map(item => {
            const p = this.productsById[item.id];
            if (!p) return null; // product deleted in DB
            return { ...p, quantity: item.quantity };
          })
          .filter(Boolean);
      },
      totalAmount() {
        return this.displayCart.reduce((sum, item) => sum + (Number(item.price) || 0) * item.quantity, 0);
      },
      allowCash() {
        return this.form.delivery === 'store' ||
               (this.form.delivery === 'delivery' && (this.form.address || '').toLowerCase().includes('phnom penh'));
      },
      allowKHQR() { return true; },
      allowCards() { return true; },
      validCheckout() {
        if (this.form.delivery === 'delivery' && this.form.payment === 'cash' && !this.allowCash) return false;
        return true;
      }
    },

    methods: {
      async fetchProductsByIds(ids) {
        if (!ids.length) { this.productsById = {}; return; }
        const res = await axios.post('/api/products/by_ids', { ids });
        this.productsById = res.data || {};
        // Clean cart if some ids no longer exist in DB
        const existingIds = new Set(Object.keys(this.productsById).map(Number));
        const cleaned = this.cart.filter(i => existingIds.has(i.id));
        if (cleaned.length !== this.cart.length) {
          this.cart = cleaned;
          writeCart(cleaned);
        }
      },
      async refreshCart() {
        this.cart = readCart();
        const ids = [...new Set(this.cart.map(i => i.id))];
        await this.fetchProductsByIds(ids);
      },

      updatePaymentOptions() {
        if (this.form.delivery === 'delivery' && this.form.payment === 'cash' && !this.allowCash) {
          this.form.payment = 'KHQR';
        }
      },

      changeQuantity(id, delta) {
        const it = this.cart.find(i => i.id === id);
        if (it) {
          it.quantity += delta;
          if (it.quantity < 1) it.quantity = 1;
          writeCart(this.cart);
          // No re-fetch needed; prices come from productsById already loaded
        }
      },
      removeItem(id) {
        this.cart = this.cart.filter(i => i.id !== id);
        writeCart(this.cart);
      },

      async placeOrder() {
        // Build items from DB data + quantities for accuracy
        const items = this.displayCart.map(i => ({
          id: i.id,
          title: i.title,
          price: Number(i.price) || 0,
          image: i.image || '',
          quantity: i.quantity
        }));

        // No items? bail out
        if (!items.length) {
          Swal.fire('Cart is empty', 'Please add items before checkout.', 'info');
          return;
        }

        const payloadCustomer = {
          fullName: `${this.form.firstname} ${this.form.lastname}`.trim(),
          email: this.form.email,
          number: this.form.number,
          address: this.form.address,
          totalAmount: this.totalAmount,
          payment: this.form.payment,
          deliveryMethod: this.form.delivery === 'store' ? 'Store Pickup' : 'Home Delivery',
          payMethod: this.form.payment,
        };

        if (this.form.payment === 'KHQR') {
          Swal.fire({
            title: 'Scan to Pay via Bakong',
            html: `
              <img src="/static/images/khqr.png" alt="KHQR" style="width: 250px; border-radius: 10px; box-shadow: 0 4px 12px rgba(0,0,0,0.2)" />
              <p class="mt-3">Please scan this QR code using your Bakong-supported app and upload your payment slip.</p>
              <input type="file" id="paymentSlip" class="form-control mt-2" accept="image/*" />
            `,
            confirmButtonText: 'I Paid',
            preConfirm: () => {
              const file = document.getElementById('paymentSlip').files[0];
              if (!file) {
                Swal.showValidationMessage('Please upload your payment slip');
                return false;
              }
              const formData = new FormData();
              formData.append('slip', file);
              formData.append('payload', JSON.stringify({
                customer: { ...payloadCustomer, isPaid: false },
                items
              }));
              return axios.post('/confirmKHQR', formData)
                .then(() => {
                  Swal.fire('Thank you!', 'Your payment is under review.', 'success');
                  localStorage.removeItem('cart_list');
                  window.location.href = '/product';
                })
                .catch(() => {
                  Swal.fire('Error', 'Something went wrong.', 'error');
                });
            }
          });
          return;
        }

        // Non-KHQR flow: send Telegram + Email
        // Non-KHQR flow: send Telegram + Email (WAIT for them)
const payload = {
  customer: { ...payloadCustomer, isPaid: true },
  items
};

try {
  await Promise.all([
    axios.post('/messageToTelegram', payload),
    axios.post('/sendEmail', payload)
  ]);
} catch (err) {
  console.error('‚ùå Order notifications failed:', err);
  Swal.fire('Error', 'We could not send your order notification. Please try again.', 'error');
  return; // stop here so we don‚Äôt clear cart or redirect
}

localStorage.removeItem('cart_list');
await Swal.fire({
  icon: 'success',
  title: 'Order Placed!',
  text: 'Your order has been successfully placed.',
  confirmButtonColor: '#6f42c1',
});
window.location.href = '/product';

      }
    },

    async mounted() {
      await this.refreshCart();
    }
  });

  app.mount('#app');
</script>

</body>
</html>
