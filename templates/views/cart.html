<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Cart</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css">
  <style>
    /* ====== Background Pattern ====== */
    body {
      font-family: 'Inter', sans-serif;
      color: #0f172a;
      margin: 0;
      background:
        radial-gradient(circle at 20% 30%, rgba(59,130,246,.15) 0, transparent 40%),
        radial-gradient(circle at 80% 70%, rgba(16,185,129,.15) 0, transparent 40%),
        repeating-linear-gradient(135deg, #f0f9ff 0 30px, #e0f2fe 30px 60px),
        linear-gradient(180deg, #ffffff, #f8fafc);
    }

    /* ====== Cart Item Cards ====== */
    .cart-item {
      border-radius: 16px;
      padding: 18px 22px;
      margin-bottom: 20px;
      background:
        repeating-linear-gradient(-45deg, rgba(99,102,241,.08) 0 20px, transparent 20px 40px),
        #fff;
      box-shadow: 0 6px 18px rgba(15,23,42,.08);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }
    .cart-item-image {
      width: 90px; height: 90px;
      border-radius: 12px;
      object-fit: contain;
      background: #f8fafc;
      padding: 6px;
      border: 2px solid #e2e8f0;
    }
    .product-title { font-weight: 700; font-size: 1.1rem; margin-bottom: 6px; }
    .product-price { font-weight: 800; font-size: 1.2rem; color: #2563eb; }

    /* ====== Quantity Selector ====== */
    .quantity-selector {
      display: flex; align-items: center;
      border-radius: 30px;
      background: repeating-linear-gradient(45deg,#e0f2fe 0 12px,#bae6fd 12px 24px);
      padding: 4px 6px;
    }
    .quantity-selector .btn {
      border-radius: 50%;
      width: 30px; height: 30px;
      background: #fff;
      border: 2px solid #cbd5e1;
      display: flex; align-items: center; justify-content: center;
      font-weight: 700;
      transition: all .2s ease;
    }
    .quantity-selector .btn:hover {
      background: #2563eb;
      color: #fff;
      border-color: #2563eb;
    }
    .quantity-value {
      padding: 0 12px;
      font-weight: 700;
      font-size: 1rem;
      color: #1f2937;
    }

    /* ====== Remove Button ====== */
    .remove-btn {
      color: #dc2626;
      cursor: pointer;
      transition: color .2s ease, transform .2s ease;
    }
    .remove-btn:hover {
      color: #b91c1c;
      transform: scale(1.15);
    }

    /* ====== Order Summary ====== */
    .order-summary {
      border-radius: 18px;
      padding: 24px;
      background:
        repeating-linear-gradient(135deg,#fef9c3 0 25px,#fef3c7 25px 50px),
        linear-gradient(#fff7ed,#fefce8);
      box-shadow: 0 6px 20px rgba(0,0,0,.08);
      position: sticky; top: 80px;
    }
    .order-summary h3 {
      font-weight: 900; margin-bottom: 1.4rem;
      background: linear-gradient(90deg,#22c55e,#3b82f6);
      -webkit-background-clip: text;
      background-clip: text;
      color: transparent;
    }
    .summary-item {
      display: flex; justify-content: space-between; margin-bottom: 1rem;
      font-weight: 600; color: #374151;
    }
    .summary-total {
      font-size: 1.3rem;
      font-weight: 900;
      color: #16a34a;
      background: linear-gradient(90deg,#dcfce7,#bbf7d0);
      padding: 6px 12px;
      border-radius: 10px;
    }
    .btn-success {
      font-weight: 800;
      border-radius: 14px;
      padding: 12px;
      background:
        repeating-linear-gradient(45deg,#34d399 0 20px,#10b981 20px 40px);
      border: none;
      transition: transform .2s ease, filter .2s ease;
    }
    .btn-success:hover {
      transform: translateY(-2px);
      filter: brightness(1.1);
      box-shadow: 0 8px 20px rgba(16,185,129,.4);
    }

    /* ====== Empty State ====== */
    #hasNoProduct .card {
      border-radius: 20px;
      background:
        repeating-linear-gradient(45deg,#e0f2fe 0 20px,#f0f9ff 20px 40px),
        #fff;
    }
    #hasNoProduct .btn-primary {
      font-weight: 700;
      border-radius: 12px;
      background:
        repeating-linear-gradient(135deg,#3b82f6 0 20px,#2563eb 20px 40px);
      border: none;
    }
  </style>
</head>
<body>

<div class="container mt-5" id="hasNoProduct" style="display: none;">
  <div class="card p-4 shadow-sm">
    <h5 class="card-title mb-4">ðŸ§¾ Order Summary</h5>
    <p class="text-muted mb-4">Your cart is empty.</p>
    <a href="/product" class="btn btn-primary">Return to Shop</a>
  </div>
</div>

<div class="container" id="hasProduct" style="display: none;">
  <div class="row">
    <div class="col-lg-8" id="cartItems"></div>
    <div class="col-lg-4">
      <div class="order-summary">
        <h3>Order Summary</h3>
        <div class="summary-item"><span>Subtotal</span> <span id="sub_total">$0.00</span></div>
        <div class="summary-item"><span>Delivery Fee</span> <span>$0.00</span></div>
        <hr>
        <div class="summary-item summary-total"><span>Total</span> <span id="total">$0.00</span></div>
        <a href="/checkout" id="btnCheckOut" class="btn btn-success w-100 mt-3">Go to Checkout</a>
      </div>
    </div>
  </div>
</div>

<script>
  async function fetchProductsByIds(ids) {
    const res = await fetch("/api/products/by_ids", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ ids })
    });
    if (!res.ok) throw new Error("Failed to load products");
    return await res.json();
  }

  function readCart() {
    const raw = JSON.parse(localStorage.getItem("cart_list") || "[]");
    return raw.map(x => ({ id: Number(x.id), quantity: Number(x.quantity || 1) }))
              .filter(x => Number.isFinite(x.id) && x.id > 0 && x.quantity > 0);
  }

  function writeCart(cart) {
    localStorage.setItem("cart_list", JSON.stringify(cart));
  }

  async function renderCart() {
    const hasNoProduct = document.getElementById("hasNoProduct");
    const hasProduct = document.getElementById("hasProduct");
    const container = document.getElementById("cartItems");
    const cart = readCart();

    if (!cart.length) {
      hasNoProduct.style.display = "block";
      hasProduct.style.display = "none";
      return;
    }

    const ids = [...new Set(cart.map(i => i.id))];
    let productMap = {};
    try {
      productMap = await fetchProductsByIds(ids);
    } catch (e) {
      console.error(e);
      hasNoProduct.style.display = "block";
      hasProduct.style.display = "none";
      return;
    }

    hasProduct.style.display = "block";
    hasNoProduct.style.display = "none";
    container.innerHTML = "";

    let total = 0;
    const filteredCart = [];

    for (const item of cart) {
      const p = productMap[item.id];
      if (!p) continue;
      filteredCart.push(item);

      const itemTotal = p.price * item.quantity;
      total += itemTotal;

      container.innerHTML += `
        <div class="cart-item" data-id="${p.id}">
          <div class="d-flex align-items-center">
            <img src="${p.image || ''}" alt="${escapeHtml(p.title)}" class="cart-item-image me-3">
            <div>
              <div class="product-title">${escapeHtml(p.title)}</div>
              <div class="product-price">$${Number(p.price).toFixed(2)}</div>
            </div>
          </div>
          <div class="d-flex align-items-center">
            <div class="quantity-selector">
              <button class="btn" onclick="changeQuantity(${p.id}, -1)">âˆ’</button>
              <span class="quantity-value">${item.quantity}</span>
              <button class="btn" onclick="changeQuantity(${p.id}, 1)">+</button>
            </div>
            <button class="btn" onclick="removeItem(${p.id})"><i class="bi bi-trash-fill remove-btn fs-5 ms-3"></i></button>
          </div>
        </div>`;
    }

    if (filteredCart.length !== cart.length) writeCart(filteredCart);

    document.getElementById("sub_total").textContent = `$${total.toFixed(2)}`;
    document.getElementById("total").textContent = `$${total.toFixed(2)}`;
  }

  function changeQuantity(id, delta) {
    const cart = readCart();
    const item = cart.find(i => i.id === id);
    if (item) {
      item.quantity += delta;
      if (item.quantity <= 0) item.quantity = 1;
      writeCart(cart);
      renderCart();
    }
  }

  function removeItem(id) {
    const cart = readCart().filter(i => i.id !== id);
    writeCart(cart);
    renderCart();
  }

  function escapeHtml(s) {
    return String(s ?? "").replace(/[&<>"']/g, m => (
      { "&":"&amp;","<":"&lt;",">":"&gt;","\"":"&quot;","'":"&#39;" }[m]
    ));
  }

  renderCart();
</script>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
</body>
</html>
